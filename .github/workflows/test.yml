name: test

on:
  pull_request:
  push:
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
    branches:
      - master

env:
  RUSTFLAGS: -Dwarnings

jobs:
  test:
    name: Test
    runs-on: windows-2019

    strategy:
      matrix:
        include:
          - version: stable
            target: x86_64-pc-windows-msvc
            no-run:
          - version: nightly
            target: i686-pc-windows-msvc
            no-run:
          - version: stable
            target: aarch64-pc-windows-msvc
            no-run: --no-run
          - version: nightly
            target: aarch64-pc-windows-msvc
            no-run: --no-run
          - version: nightly
            target: x86_64-pc-windows-gnu
            no-run:
          - version: stable
            target: i686-pc-windows-gnu
            no-run:

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Add toolchain target
        run: rustup target add ${{ matrix.target }}
      - name: Update toolchain
        run: rustup update --no-self-update ${{ matrix.version }} && rustup default ${{ matrix.version }}
      - name: Fix environment
        uses: ./.github/actions/fix-environment
      - name: Clean
        run:  cargo clean
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p riddle -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_bits -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_com_uri -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_component_hello_world -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_component_json_validator -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_component_json_validator_winrt -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_component_json_validator_winrt_client -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_consent -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_core_app -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_counter -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_counter_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_create_window -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_create_window_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_credentials -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_data_protection -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_dcomp -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_delay_load -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_delay_load_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_device_watcher -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_direct2d -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_direct3d12 -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_enum_windows -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_enum_windows_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_kernel_event -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_memory_buffer -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_message_box -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_message_box_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_ocr -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_overlapped -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_privileges -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_privileges_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_rss -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_shell -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_simple -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_spellchecker -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_task_dialog -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_task_dialog_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_thread_pool_work -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_thread_pool_work_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_uiautomation -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_wmi -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_xml -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_agile -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_agile_reference -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_alternate_success_code -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_arch -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_arch_feature -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_array -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_bcrypt -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_bstr -Z build-std
      - name: Clean
        run:  cargo clean
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_calling_convention -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_cfg_generic -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_collections -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_component -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_component_client -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_const_fields -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_const_params -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_const_ptrs -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_core -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_debug -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_debug_inspectable -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_debugger_visualizer -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_deprecated -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_dispatch -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_does_not_return -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_enums -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_error -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_event -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_extensions -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_handles -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_helpers -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_implement -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_interface -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_interface_core -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_interop -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_lib -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_literals -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_match -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_matrix3x2 -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_metadata -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_msrv -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_no_use -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_not_dll -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_query_signature -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_readme -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_registry -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_reserved -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_resources -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_result -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_return_handle -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_return_struct -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_riddle -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_simple_component -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_standalone -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_string_param -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_structs -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_targets -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_unions -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_variant -Z build-std
      - name: Clean
        run:  cargo clean
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_wdk -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_weak -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_weak_ref -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_win32 -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_win32_arrays -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_window_long -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_winrt -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_gnu -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_lib -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_license -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_metadata -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_msvc -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_windows -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_yml -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-bindgen -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-core -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-implement -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-interface -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-metadata -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-registry -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-result -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-sys -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-targets -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-version -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_aarch64_gnullvm -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_aarch64_msvc -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_i686_gnu -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_i686_gnullvm -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_i686_msvc -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_x86_64_gnu -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_x86_64_gnullvm -Z build-std
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_x86_64_msvc -Z build-std
      - name: Check diff
        shell: bash
        run: |
          git add -N .
          git diff --exit-code || (echo 'Tests changed code in the repo.'; exit 1)

name: test

on:
  pull_request:
  push:
    paths-ignore:
      - '.github/ISSUE_TEMPLATE/**'
    branches:
      - master

env:
  RUSTFLAGS: -Dwarnings

jobs:
  test:
    name: Test
    runs-on: windows-2019

    strategy:
      matrix:
        include:
          - version: stable
            target: x86_64-pc-windows-msvc
            no-run:
          - version: nightly
            target: i686-pc-windows-msvc
            no-run:
          - version: stable
            target: aarch64-pc-windows-msvc
            no-run: --no-run
          - version: nightly
            target: aarch64-pc-windows-msvc
            no-run: --no-run
          - version: nightly
            target: x86_64-pc-windows-gnu
            no-run:
          - version: stable
            target: i686-pc-windows-gnu
            no-run:

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Add toolchain target
        run: rustup target add ${{ matrix.target }}
      - name: Update toolchain
        run: rustup update --no-self-update ${{ matrix.version }} && rustup default ${{ matrix.version }}
      - name: Fix environment
        uses: ./.github/actions/fix-environment
      - name: Clean
        run:  cargo clean
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p riddle
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_bits
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_com_uri
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_component_hello_world
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_component_json_validator
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_component_json_validator_winrt
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_component_json_validator_winrt_client
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_consent
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_core_app
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_counter
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_counter_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_create_window
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_create_window_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_credentials
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_data_protection
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_dcomp
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_delay_load
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_delay_load_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_device_watcher
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_direct2d
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_direct3d12
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_enum_windows
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_enum_windows_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_kernel_event
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_memory_buffer
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_message_box
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_message_box_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_ocr
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_overlapped
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_privileges
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_privileges_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_rss
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_shell
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_simple
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_spellchecker
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_task_dialog
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_task_dialog_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_thread_pool_work
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_thread_pool_work_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_uiautomation
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_wmi
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p sample_xml
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_agile
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_agile_reference
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_alternate_success_code
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_arch
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_arch_feature
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_array
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_bcrypt
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_bstr
      - name: Clean
        run:  cargo clean
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_calling_convention
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_cfg_generic
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_collections
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_component
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_component_client
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_const_fields
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_const_params
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_const_ptrs
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_core
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_debug
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_debug_inspectable
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_debugger_visualizer
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_deprecated
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_dispatch
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_does_not_return
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_enums
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_error
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_event
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_extensions
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_handles
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_helpers
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_implement
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_interface
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_interface_core
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_interop
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_lib
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_literals
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_match
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_matrix3x2
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_metadata
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_msrv
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_no_use
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_not_dll
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_query_signature
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_readme
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_registry
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_reserved
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_resources
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_result
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_return_handle
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_return_struct
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_riddle
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_simple_component
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_standalone
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_string_param
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_structs
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_targets
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_unions
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_variant
      - name: Clean
        run:  cargo clean
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_wdk
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_weak
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_weak_ref
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_win32
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_win32_arrays
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_window_long
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p test_winrt
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_gnu
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_lib
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_license
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_metadata
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_msvc
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_windows
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p tool_yml
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-bindgen
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-core
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-implement
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-interface
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-metadata
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-registry
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-result
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-sys
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-targets
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows-version
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_aarch64_gnullvm
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_aarch64_msvc
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_i686_gnu
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_i686_gnullvm
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_i686_msvc
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_x86_64_gnu
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_x86_64_gnullvm
      - name: Test
        run:  cargo test ${{ matrix.no-run }} --target ${{ matrix.target }} -p windows_x86_64_msvc
      - name: Check diff
        shell: bash
        run: |
          git add -N .
          git diff --exit-code || (echo 'Tests changed code in the repo.'; exit 1)
